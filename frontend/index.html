<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Danggeun Logistics AI</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [í…Œë§ˆ] ë‹¹ê·¼ë§ˆì¼“ ìŠ¤íƒ€ì¼ */
        :root {
            --primary: #FF8A3D; /* ë‹¹ê·¼ ì£¼í™© */
            --bg-body: #F8F9FA; /* ë°ì€ íšŒìƒ‰ ë°°ê²½ */
            --bg-card: #FFFFFF;
            --text-main: #212529;
            --text-sub: #868E96;
            --border: #E9ECEF;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        body {
            margin: 0; height: 100vh; display: flex;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-body); color: var(--text-main);
        }

        /* ì™¼ìª½: ë©”ì¸ (ìƒë‹¨ í”„ë¡œì„¸ìŠ¤ + í•˜ë‹¨ ê·¸ë˜í”„) */
        #main-view { flex: 7; display: flex; flex-direction: column; height: 100%; border-right: 1px solid var(--border); }
        
        /* [ìƒë‹¨] ë¬¼ë¥˜ í”„ë¡œì„¸ìŠ¤ ë·° (Process View) */
        #top-process-panel {
            flex: 3; background: var(--bg-card); padding: 20px;
            display: flex; align-items: center; justify-content: center; gap: 30px;
            border-bottom: 1px solid var(--border);
        }
        
        .process-card {
            background: white; border: 2px solid var(--border); border-radius: 16px;
            width: 200px; padding: 20px; text-align: center;
            box-shadow: var(--shadow); transition: all 0.2s; cursor: pointer;
            position: relative;
        }
        .process-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .process-card.active { border-color: var(--primary); background: #FFF3E0; }
        
        .p-icon { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .p-title { font-size: 1.1rem; font-weight: bold; color: var(--text-main); }
        .p-count { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 10px 0; }
        .p-desc { font-size: 0.85rem; color: var(--text-sub); }
        
        .arrow { font-size: 1.5rem; color: var(--text-sub); }

        /* [í•˜ë‹¨] ì˜¨í†¨ë¡œì§€ ê·¸ë˜í”„ */
        #bottom-graph-panel { flex: 7; position: relative; background: #F1F3F5; }
        #graph-container { width: 100%; height: 100%; }
        .panel-label {
            position: absolute; top: 15px; left: 20px; z-index: 10;
            background: rgba(255,255,255,0.9); padding: 5px 12px;
            border-radius: 20px; font-weight: bold; color: var(--text-sub); font-size: 0.8rem;
            box-shadow: var(--shadow);
        }

        /* ì˜¤ë¥¸ìª½: ì‚¬ì´ë“œë°” (ì •ë³´ + ì±„íŒ…) */
        #sidebar { flex: 3; display: flex; flex-direction: column; background: var(--bg-card); }
        
        /* ì •ë³´ì°½ */
        #info-panel {
            flex: 4; padding: 20px; border-bottom: 1px solid var(--border); overflow-y: auto;
        }
        .info-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;}
        .event-item {
            background: #FFF3E0; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem;
            border-left: 4px solid var(--primary);
        }
        .event-item.error { background: #FFEBEE; border-left-color: #FF5252; }
        
        /* ì±„íŒ…ì°½ */
        #chat-panel { flex: 6; display: flex; flex-direction: column; padding: 20px; background: #F8F9FA; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .msg { padding: 10px 14px; margin: 6px 0; border-radius: 12px; max-width: 80%; font-size: 0.95rem; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; }
        .bot { background: white; border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 0; }
        
        #input-area { display: flex; gap: 10px; }
        #chat-input {
            flex: 1; padding: 12px; border: 1px solid #CED4DA; border-radius: 20px; outline: none;
        }
        #chat-input:focus { border-color: var(--primary); }

        /* Toast */
        #toast {
            position: fixed; top: 20px; right: 50%; transform: translateX(50%);
            background: rgba(33, 37, 41, 0.9); color: white; padding: 12px 24px;
            border-radius: 30px; z-index: 1000; opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        #toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div id="toast">ì•Œë¦¼ì´ ì—¬ê¸°ì— ëœ¹ë‹ˆë‹¤</div>

    <div id="main-view">
        <div id="top-process-panel">
            <div class="process-card" onclick="selectZone('Z_IN')" id="card-Z_IN">
                <div class="p-icon"><i class="fas fa-truck-loading"></i></div>
                <div class="p-title">ì…ê³ ì¡´</div>
                <div class="p-count" id="count-Z_IN">0</div>
                <div class="p-desc">Inbound</div>
            </div>
            
            <div class="arrow"><i class="fas fa-chevron-right"></i></div>
            
            <div class="process-card" onclick="selectZone('Z_SORT')" id="card-Z_SORT">
                <div class="p-icon"><i class="fas fa-random"></i></div>
                <div class="p-title">ë¶„ë¥˜ì¡´</div>
                <div class="p-count" id="count-Z_SORT">0</div>
                <div class="p-desc">Sorting</div>
            </div>

            <div class="arrow"><i class="fas fa-chevron-right"></i></div>

            <div class="process-card" onclick="selectZone('Z_OUT')" id="card-Z_OUT">
                <div class="p-icon"><i class="fas fa-shipping-fast"></i></div>
                <div class="p-title">ì¶œê³ ì¡´</div>
                <div class="p-count" id="count-Z_OUT">0</div>
                <div class="p-desc">Outbound</div>
            </div>
        </div>

        <div id="bottom-graph-panel">
            <div class="panel-label">ğŸ•¸ï¸ Ontology Structure (Fixed)</div>
            <div id="graph-container"></div>
        </div>
    </div>

    <div id="sidebar">
        <div id="info-panel">
            <div class="info-header"><i class="fas fa-info-circle"></i> ìƒì„¸ í˜„í™©</div>
            <div id="info-content" style="color:#868E96;">êµ¬ì—­ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            
            <div style="margin-top:20px; font-weight:bold; margin-bottom:10px;">ğŸ”” ìµœê·¼ ì´ë²¤íŠ¸</div>
            <div id="event-list"></div>
        </div>

        <div id="chat-panel">
            <div id="messages">
                <div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! ë‹¹ê·¼ ë¬¼ë¥˜ AIì…ë‹ˆë‹¤. ğŸ¥•<br>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
            </div>
            <div id="input-area">
                <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter') send()">
            </div>
        </div>
    </div>

    <script>
        // 1. Vis.js ê·¸ë˜í”„ ì„¤ì • (ê³ ì •í˜•)
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const container = document.getElementById('graph-container');
        const network = new vis.Network(container, { nodes, edges }, {
            nodes: { 
                shape: 'dot', size: 25, 
                font: { face: 'arial', color: '#333' },
                borderWidth: 2, shadow: true
            },
            edges: { color: '#B0BEC5', arrows: 'to', width: 2 },
            physics: {
                enabled: true,
                solver: 'forceAtlas2Based',
                stabilization: { enabled: true, iterations: 200 }
            },
            interaction: { hover: true }
        });

        // ì•ˆì •í™” í›„ ë¬¼ë¦¬ì—”ì§„ ì •ì§€ (í”ë“¤ë¦¼ ë°©ì§€)
        network.once("stabilizationIterationsDone", () => {
            network.setOptions({ physics: { enabled: false } });
        });

        // 2. ë°ì´í„° í´ë§ ë° UI ì—…ë°ì´íŠ¸
        let selectedZoneId = null;
        let globalStats = null;

        async function updateData() {
            try {
                // A. í†µê³„ ì—…ë°ì´íŠ¸ (ìƒë‹¨ ì¹´ë“œ)
                const dRes = await fetch('/api/dashboard-stats');
                globalStats = await dRes.json();
                
                // ì¹´ë“œ ìˆ«ì ê°±ì‹ 
                globalStats.zones.forEach(z => {
                    const el = document.getElementById(`count-${z.id}`);
                    if (el) el.innerText = z.count;
                });

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  (ì‚¬ì´ë“œë°”)
                const evtDiv = document.getElementById('event-list');
                evtDiv.innerHTML = '';
                globalStats.events.forEach(e => {
                    const isErr = e.type === 'ERROR';
                    evtDiv.innerHTML += `
                        <div class="event-item ${isErr ? 'error' : ''}">
                            <div style="font-weight:bold; margin-bottom:4px;">${isErr ? 'ì¥ì• ' : 'í”„ë¡œëª¨ì…˜'}</div>
                            ${e.desc}
                        </div>`;
                });

                // ì„ íƒëœ êµ¬ì—­ ì •ë³´ ê°±ì‹ 
                if (selectedZoneId) renderInfo(selectedZoneId);

                // B. ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ (í•˜ë‹¨)
                const gRes = await fetch('/api/graph-data');
                const gData = await gRes.json();
                nodes.update(gData.nodes);
                edges.update(gData.edges);

            } catch (e) { console.error(e); }
        }
        setInterval(updateData, 1500); // 1.5ì´ˆë§ˆë‹¤ ê°±ì‹ 

        // 3. ì¸í„°ë™ì…˜ (ì¹´ë“œ í´ë¦­)
        window.selectZone = function(zoneId) {
            selectedZoneId = zoneId;
            
            // ì¹´ë“œ ìŠ¤íƒ€ì¼ í™œì„±í™”
            document.querySelectorAll('.process-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${zoneId}`).classList.add('active');

            // ì‚¬ì´ë“œë°” ì •ë³´ í‘œì‹œ
            renderInfo(zoneId);

            // ê·¸ë˜í”„ì—ì„œ í•´ë‹¹ ë…¸ë“œ ê°•ì¡°
            network.selectNodes([zoneId]);
            network.focus(zoneId, { animation: true, scale: 1.2 });
        }

        function renderInfo(zoneId) {
            const zData = globalStats.zones.find(z => z.id === zoneId);
            const content = document.getElementById('info-content');
            
            if (zData) {
                content.innerHTML = `
                    <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);">${zData.name}</div>
                    <div style="margin-top:10px; font-size:1.1rem;">ğŸ“¦ í˜„ì¬ ì ì¬ëŸ‰: <b>${zData.count}</b>ê°œ</div>
                    <div style="margin-top:5px; color:#868E96;">ID: ${zData.id}</div>
                    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                    <div>ìƒíƒœ: <span style="color:#4CAF50; font-weight:bold;">ì •ìƒ ìš´ì˜ ì¤‘</span></div>
                `;
            }
        }

        // 4. ì±„íŒ…
        async function send() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if (!text) return;

            addMsg(text, 'user');
            input.value = '';

            const res = await fetch('/api/chat', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text})
            });
            const data = await res.json();
            addMsg(data.reply, 'bot');
            
            // ê´€ë ¨ ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸
            if (data.related_nodes && data.related_nodes.length > 0) {
                network.selectNodes(data.related_nodes);
                showToast("ê´€ë ¨ëœ ì˜¨í†¨ë¡œì§€ ë…¸ë“œê°€ ê°•ì¡°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        function addMsg(txt, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = txt;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 99999;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
