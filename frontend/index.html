<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Logistics Command Center</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212; --bg-panel: #1E1E1E;
            --text-primary: #E0E0E0; --text-secondary: #A0A0A0;
            --accent-blue: #2196F3; --accent-red: #FF5252; --accent-purple: #E040FB;
            --border-color: #333;
        }
        body { 
            display: flex; height: 100vh; margin: 0; background: var(--bg-dark); color: var(--text-primary);
            font-family: 'Segoe UI', sans-serif; overflow: hidden;
        }
        #main-container { display: flex; width: 100%; height: 100%; }
        #graph-panel { flex: 7; position: relative; border-right: 1px solid var(--border-color); }
        #graph-container { width: 100%; height: 100%; background: #191919; }
        .panel-header { position: absolute; top: 15px; left: 20px; z-index: 10; font-weight: bold; color: var(--accent-blue); }

        #sidebar { flex: 3; display: flex; flex-direction: column; background: var(--bg-panel); }
        #dashboard { flex: 4; padding: 20px; border-bottom: 1px solid var(--border-color); overflow-y: auto; }
        #chat-panel { flex: 6; display: flex; flex-direction: column; padding: 20px; }
        
        /* Stats Cards */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .card { background: #2C2C2C; padding: 15px; border-radius: 6px; text-align: center; }
        .card-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }
        .card-value { font-size: 1.5rem; font-weight: bold; }
        .card.alert { border-bottom: 3px solid var(--accent-red); }
        .card.promo { border-bottom: 3px solid var(--accent-purple); }

        /* Chat */
        #messages { flex: 1; overflow-y: auto; background: #151515; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 4px; max-width: 85%; font-size: 0.9rem; }
        .user { background: #1565C0; align-self: flex-end; margin-left: auto; }
        .bot { background: #424242; }
        #input-box { width: 100%; padding: 12px; background: #2C2C2C; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 32%; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(0,0,0,0.85); color: white; padding: 15px 20px; border-radius: 4px; border-left: 5px solid var(--accent-blue); animation: slideIn 0.3s; width: 300px;}
        .toast.error { border-left-color: var(--accent-red); }
        .toast.promo { border-left-color: var(--accent-purple); box-shadow: 0 0 15px var(--accent-purple); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="main-container">
        <div id="graph-panel">
            <div class="panel-header">ðŸ“¡ LIVE LOGISTICS TWIN</div>
            <div id="graph-container"></div>
        </div>

        <div id="sidebar">
            <div id="dashboard">
                <div style="font-weight:bold; margin-bottom:10px;">ðŸ“Š OPERATIONAL STATUS</div>
                <div class="stat-grid">
                    <div class="card alert">
                        <div class="card-title">ERRORS</div>
                        <div class="card-value" id="val-error">0</div>
                    </div>
                    <div class="card promo">
                        <div class="card-title">PROMOTIONS</div>
                        <div class="card-value" id="val-promo">0</div>
                    </div>
                </div>
                <div style="margin-top:20px; font-size:0.9rem; color:#888;">ZONE THROUGHPUT</div>
                <div id="zone-list" style="margin-top:10px; display:flex; flex-direction:column; gap:5px;"></div>
            </div>

            <div id="chat-panel">
                <div id="messages"></div>
                <input type="text" id="input-box" placeholder="Ask AI (e.g., 'í˜„ìž¬ ë³‘ëª© êµ¬ê°„ì€?', 'ì´ë²¤íŠ¸ ìžˆì–´?')..." onkeypress="if(event.key==='Enter') send()">
            </div>
        </div>
    </div>

    <script>
        // 1. Graph Config (Physics stops after stabilization)
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const container = document.getElementById('graph-container');
        const network = new vis.Network(container, { nodes, edges }, {
            nodes: { shape: 'dot', size: 15, font: { color: '#fff', size: 12 } },
            edges: { arrows: 'to', color: '#546E7A' },
            physics: {
                enabled: true,
                stabilization: { iterations: 500, updateInterval: 100 },
                solver: 'forceAtlas2Based',
            }
        });

        // **í•µì‹¬**: ì•ˆì •í™”ë˜ë©´ ë¬¼ë¦¬ì—”ì§„ ë„ê¸° (ëº‘ê¸€ëº‘ê¸€ ë°©ì§€)
        network.once("stabilizationIterationsDone", () => {
            network.setOptions({ physics: { enabled: false } }); 
        });

        // 2. Data Polling
        let knownEvents = new Set(); // ì•Œë¦¼ ì¤‘ë³µ ë°©ì§€ìš©

        async function updateData() {
            try {
                // A. Graph Update
                const gRes = await fetch('/api/graph-data');
                const gData = await gRes.json();
                
                // ê¸°ì¡´ ë…¸ë“œ ìœ„ì¹˜ ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸
                nodes.update(gData.nodes); 
                // ì—£ì§€ëŠ” ìƒˆë¡œ ê·¸ë¦¬ê¸° (ìž”ìƒ ë°©ì§€)
                const currentEdgeIds = edges.getIds();
                const newEdgeIds = gData.edges.map(e => `${e.from}-${e.to}`);
                edges.remove(currentEdgeIds.filter(id => !newEdgeIds.includes(id)));
                edges.update(gData.edges);

                // B. Dashboard Update
                const dRes = await fetch('/api/dashboard-stats');
                const dData = await dRes.json();
                
                document.getElementById('val-error').innerText = dData.errors;
                document.getElementById('val-promo').innerText = dData.promotions;
                
                const zoneDiv = document.getElementById('zone-list');
                zoneDiv.innerHTML = '';
                dData.zones.forEach(z => {
                    zoneDiv.innerHTML += `
                        <div style="background:#252525; padding:8px; display:flex; justify-content:space-between; border-radius:4px;">
                            <span>${z.name}</span> <span style="font-weight:bold; color:#2196F3">${z.count} units</span>
                        </div>`;
                });

                // C. Toast Alerts (ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ê°ì§€ ì‹œ)
                dData.recent_events.forEach(desc => {
                    if (!knownEvents.has(desc)) {
                        knownEvents.add(desc);
                        showToast(desc);
                    }
                });

            } catch (e) { console.error(e); }
        }
        setInterval(updateData, 2000);

        // 3. Toast UI Logic
        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            if (msg.includes('í”„ë¡œëª¨ì…˜')) el.className += ' promo';
            if (msg.includes('ê²½ê³ ') || msg.includes('ì‹¤íŒ¨')) el.className += ' error';
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 5000); // 5ì´ˆ ë’¤ ì‚­ì œ
        }

        // 4. Chat & Highlight Logic
        async function send() {
            const input = document.getElementById('input-box');
            const text = input.value;
            if (!text) return;

            addMsg(text, 'user');
            input.value = '';
            
            const res = await fetch('/api/chat', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text})
            });
            const data = await res.json();
            addMsg(data.reply, 'bot');

            if (data.related_nodes && data.related_nodes.length > 0) {
                highlight(data.related_nodes);
            } else {
                nodes.update(nodes.get().map(n => ({id: n.id, opacity: 1}))); // Reset
            }
        }

        function highlight(ids) {
            const all = nodes.get();
            const updates = all.map(n => ({
                id: n.id,
                color: ids.includes(n.id) ? {background: '#FFF', border: '#FFD700'} : {background: '#333', border: '#222'},
                opacity: ids.includes(n.id) ? 1 : 0.2
            }));
            nodes.update(updates);
            network.fit({ nodes: ids, animation: true });
        }

        function addMsg(txt, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = txt;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 9999;
        }
    </script>
</body>
</html>
