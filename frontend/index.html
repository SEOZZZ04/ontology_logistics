<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Korea Logistics AI</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6F00; --bg-body: #F5F7FA; --bg-card: #FFFFFF;
            --text-main: #263238; --text-sub: #78909C; --border: #ECEFF1;
        }
        body { margin: 0; height: 100vh; display: flex; font-family: 'Pretendard', sans-serif; background: var(--bg-body); color: var(--text-main); }
        #main-view { flex: 7; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        #top-process-panel { flex: 3; background: var(--bg-card); padding: 20px; display: flex; align-items: center; justify-content: center; gap: 40px; border-bottom: 1px solid var(--border); }
        .process-card { background: white; border: 2px solid var(--border); border-radius: 12px; width: 180px; padding: 25px 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .process-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .process-card.active { border-color: var(--primary); background: #FFF8E1; }
        .p-count { font-size: 2.2rem; font-weight: 800; margin: 10px 0; }
        
        #bottom-graph-panel { flex: 7; position: relative; background: #FAFAFA; }
        #graph-container { width: 100%; height: 100%; }
        
        #sidebar { flex: 3; display: flex; flex-direction: column; background: var(--bg-card); }
        #info-panel { flex: 4; padding: 25px; border-bottom: 1px solid var(--border); overflow-y: auto; }
        #chat-panel { flex: 6; padding: 20px; background: #F5F7FA; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; }
        .msg { padding: 12px 16px; margin: 8px 0; border-radius: 12px; max-width: 85%; }
        .user { background: var(--primary); color: white; align-self: flex-end; }
        .bot { background: white; border: 1px solid #CFD8DC; align-self: flex-start; }
        #chat-input { width: 100%; padding: 14px; border: 1px solid #CFD8DC; border-radius: 25px; outline: none; }
        
        .event-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .event-item.error { border-left-color: #D32F2F; background: #FFEBEE; }
    </style>
</head>
<body>
    <div id="main-view">
        <div id="top-process-panel">
            <div class="process-card" onclick="selectZone('Z_IN')" id="card-Z_IN">
                <div style="color:var(--primary); font-size:2rem; margin-bottom:10px;"><i class="fas fa-dolly"></i></div>
                <div style="font-weight:bold;">ì…ê³ (Inbound)</div>
                <div class="p-count" id="count-Z_IN">0</div>
            </div>
            <div style="font-size:1.5rem; color:#CFD8DC;"><i class="fas fa-arrow-right"></i></div>
            <div class="process-card" onclick="selectZone('Z_SORT')" id="card-Z_SORT">
                <div style="color:var(--primary); font-size:2rem; margin-bottom:10px;"><i class="fas fa-boxes"></i></div>
                <div style="font-weight:bold;">ë¶„ë¥˜(Sorting)</div>
                <div class="p-count" id="count-Z_SORT">0</div>
            </div>
            <div style="font-size:1.5rem; color:#CFD8DC;"><i class="fas fa-arrow-right"></i></div>
            <div class="process-card" onclick="selectZone('Z_OUT')" id="card-Z_OUT">
                <div style="color:var(--primary); font-size:2rem; margin-bottom:10px;"><i class="fas fa-truck-loading"></i></div>
                <div style="font-weight:bold;">ì¶œê³ (Outbound)</div>
                <div class="p-count" id="count-Z_OUT">0</div>
            </div>
        </div>
        <div id="bottom-graph-panel">
            <div id="graph-container"></div>
            <div style="position:absolute; top:20px; left:20px; background:white; padding:8px 16px; border-radius:20px; border:1px solid #ECEFF1; font-weight:bold;">
                <i class="fas fa-project-diagram" style="color:var(--primary)"></i> Ontology View
            </div>
        </div>
    </div>
    <div id="sidebar">
        <div id="info-panel">
            <div style="font-size:1.2rem; font-weight:bold; color:var(--primary); margin-bottom:20px;">
                <i class="fas fa-chart-line"></i> ìš´ì˜ í˜„í™©
            </div>
            <div id="info-content" style="color:#78909C;">êµ¬ì—­ì„ í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
            <div style="margin-top:30px; font-weight:bold; margin-bottom:15px; color:#37474F;">ğŸ”” ì‹¤ì‹œê°„ ì´ë²¤íŠ¸</div>
            <div id="event-list"></div>
        </div>
        <div id="chat-panel">
            <div id="messages"><div class="msg bot">í•œêµ­ë¬¼ë¥˜ AI ê´€ì œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ğŸ‡°ğŸ‡·</div></div>
            <div style="margin-top:10px;"><input type="text" id="chat-input" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="if(event.key==='Enter') send()"></div>
        </div>
    </div>

    <script>
        // [í•µì‹¬ ë³€ê²½] physics: falseë¡œ ì„¤ì •í•˜ì—¬ DBì—ì„œ ì˜¨ x, y ì¢Œí‘œë¥¼ ê°•ì œ ì‚¬ìš©
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const container = document.getElementById('graph-container');
        const network = new vis.Network(container, { nodes, edges }, {
            nodes: { shape: 'dot', size: 25, font: { size: 14, color: '#37474F' }, borderWidth: 2, shadow: true },
            edges: { color: '#B0BEC5', arrows: 'to', width: 2, smooth: { type: 'continuous' } },
            physics: { enabled: false }, // ë¬¼ë¦¬ ì—”ì§„ ë„ê¸° (ì¢Œí‘œ ê³ ì •)
            interaction: { dragNodes: false, zoomView: true, dragView: true } // ë…¸ë“œ ë“œë˜ê·¸ ë§‰ê¸° (ì™„ì „ ê³ ì •)
        });

        let isFirst = true;

        async function updateData() {
            try {
                // 1. ëŒ€ì‹œë³´ë“œ í†µê³„
                const dRes = await fetch('/api/dashboard-stats');
                const stats = await dRes.json();
                stats.zones.forEach(z => {
                    const el = document.getElementById(`count-${z.id}`);
                    if(el) el.innerText = z.count;
                });
                
                const evtDiv = document.getElementById('event-list');
                evtDiv.innerHTML = '';
                stats.events.forEach(e => {
                    const isErr = e.type === 'ERROR';
                    evtDiv.innerHTML += `<div class="event-item ${isErr?'error':''}"><div style="font-weight:bold; color:${isErr?'#D32F2F':'#7B1FA2'}">${isErr?'âš  ì¥ì• ':'âœ¨ í”„ë¡œëª¨ì…˜'}</div>${e.desc}</div>`;
                });

                // 2. ê·¸ë˜í”„ ë°ì´í„°
                const gRes = await fetch('/api/graph-data');
                const gData = await gRes.json();
                
                if (gData.nodes.length > 0) {
                    nodes.update(gData.nodes);
                    edges.update(gData.edges);
                    if (isFirst) {
                        network.fit(); // ì²˜ìŒì—ë§Œ ì¤‘ì•™ ì •ë ¬
                        isFirst = false;
                    }
                }
            } catch(e) { console.error(e); }
        }
        setInterval(updateData, 2000);

        window.selectZone = function(id) {
            document.querySelectorAll('.process-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${id}`).classList.add('active');
            
            // ìƒì„¸ ì •ë³´ í‘œì‹œ ë¡œì§ (ê°„ì†Œí™”)
            document.getElementById('info-content').innerHTML = `<div style="font-size:1.5rem; font-weight:bold; color:var(--primary)">${id}</div><div>ì„ íƒëœ êµ¬ì—­ì…ë‹ˆë‹¤.</div>`;
            
            network.selectNodes([id]);
            network.focus(id, { animation: true, scale: 1.2 });
        }

        async function send() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;
            
            const div = document.createElement('div'); div.className='msg user'; div.innerText=text;
            document.getElementById('messages').appendChild(div);
            input.value='';
            
            const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:text})});
            const data = await res.json();
            
            const botDiv = document.createElement('div'); botDiv.className='msg bot'; botDiv.innerHTML=data.reply;
            document.getElementById('messages').appendChild(botDiv);

            if(data.related_nodes && data.related_nodes.length > 0) {
                network.selectNodes(data.related_nodes);
                network.fit({ nodes: data.related_nodes, animation: true });
            }
        }
    </script>
</body>
</html>
