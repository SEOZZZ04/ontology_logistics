<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Korea Logistics AI</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #FF6F00; --bg-body: #F5F7FA; --bg-card: #FFFFFF; --text-main: #263238; --border: #ECEFF1; }
        body { margin: 0; height: 100vh; display: flex; font-family: 'Pretendard', sans-serif; background: var(--bg-body); color: var(--text-main); }
        
        #main-view { flex: 7; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        #top-process-panel { flex: 3; background: var(--bg-card); padding: 20px; display: flex; justify-content: center; gap: 30px; border-bottom: 1px solid var(--border); align-items: center; }
        
        .process-card { background: white; border: 2px solid var(--border); border-radius: 12px; width: 160px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
        .process-card.active { border-color: var(--primary); background: #FFF8E1; }
        .p-count { font-size: 2rem; font-weight: 800; margin: 10px 0; }
        
        #bottom-graph-panel { flex: 7; position: relative; background: #FAFAFA; }
        /* ë†’ì´ 100% í•„ìˆ˜ */
        #graph-container { width: 100%; height: 100%; }
        
        #sidebar { flex: 3; display: flex; flex-direction: column; background: var(--bg-card); }
        #info-panel { flex: 4; padding: 20px; border-bottom: 1px solid var(--border); overflow-y: auto; }
        #chat-panel { flex: 6; padding: 20px; background: #F5F7FA; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; }
        .msg { padding: 10px 14px; margin: 5px 0; border-radius: 10px; max-width: 85%; font-size: 0.9rem;}
        .user { background: var(--primary); color: white; align-self: flex-end; }
        .bot { background: white; border: 1px solid #CFD8DC; align-self: flex-start; }
        #chat-input { width: 100%; padding: 12px; border: 1px solid #CFD8DC; border-radius: 20px; }
        
        .event-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #ccc; font-size: 0.9rem; }
        .event-item.ERROR { border-left-color: #D32F2F; background: #FFEBEE; }
        .event-item.PROMO { border-left-color: #7B1FA2; background: #F3E5F5; }
    </style>
</head>
<body>
    <div id="main-view">
        <div id="top-process-panel">
            <div class="process-card" onclick="selectZone('Z_IN')" id="card-Z_IN">
                <i class="fas fa-dolly" style="color:var(--primary); font-size:1.5rem;"></i>
                <div style="font-weight:bold; margin-top:5px;">ì…ê³ (Inbound)</div>
                <div class="p-count" id="count-Z_IN">0</div>
            </div>
            <i class="fas fa-arrow-right" style="color:#CFD8DC; font-size:1.2rem;"></i>
            <div class="process-card" onclick="selectZone('Z_SORT')" id="card-Z_SORT">
                <i class="fas fa-boxes" style="color:var(--primary); font-size:1.5rem;"></i>
                <div style="font-weight:bold; margin-top:5px;">ë¶„ë¥˜(Sorting)</div>
                <div class="p-count" id="count-Z_SORT">0</div>
            </div>
            <i class="fas fa-arrow-right" style="color:#CFD8DC; font-size:1.2rem;"></i>
            <div class="process-card" onclick="selectZone('Z_OUT')" id="card-Z_OUT">
                <i class="fas fa-truck-loading" style="color:var(--primary); font-size:1.5rem;"></i>
                <div style="font-weight:bold; margin-top:5px;">ì¶œê³ (Outbound)</div>
                <div class="p-count" id="count-Z_OUT">0</div>
            </div>
        </div>
        <div id="bottom-graph-panel">
            <div id="graph-container"></div>
            <div style="position:absolute; top:10px; left:10px; background:white; padding:5px 10px; border-radius:15px; border:1px solid #ECEFF1; font-size:0.8rem; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                ğŸ•¸ï¸ Ontology View (Auto Layout)
            </div>
        </div>
    </div>
    <div id="sidebar">
        <div id="info-panel">
            <div style="font-weight:bold; color:var(--primary); margin-bottom:10px;">ğŸ“Š ìš´ì˜ í˜„í™©</div>
            <div id="event-list"></div>
        </div>
        <div id="chat-panel">
            <div id="messages"><div class="msg bot">í•œêµ­ë¬¼ë¥˜ AIì…ë‹ˆë‹¤. ğŸ‡°ğŸ‡·</div></div>
            <div style="margin-top:10px;"><input type="text" id="chat-input" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="if(event.key==='Enter') send()"></div>
        </div>
    </div>

    <script>
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const container = document.getElementById('graph-container');
        
        // [ì„¤ì •] ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ + ë¬¼ë¦¬ ì—”ì§„ ìµœì í™”
        const network = new vis.Network(container, { nodes, edges }, {
            nodes: { shape: 'dot', size: 20, font: { size: 14, color: '#37474F' }, borderWidth: 2, shadow: true },
            edges: { width: 2, smooth: { type: 'cubicBezier' } },
            layout: {
                hierarchical: {
                    enabled: true,
                    direction: 'UD', // Up-Down
                    sortMethod: 'directed',
                    levelSeparation: 120, // ì¸µ ê°„ê²©
                    nodeSpacing: 150      // ë…¸ë“œ ê°„ê²©
                }
            },
            physics: {
                enabled: true, // ì´ˆê¸° ìë¦¬ì¡ê¸°ë¥¼ ìœ„í•´ True
                hierarchicalRepulsion: {
                    nodeDistance: 150,
                    springLength: 100,
                    damping: 0.09
                },
                stabilization: {
                    iterations: 100 // 100ë²ˆ ê³„ì‚° í›„ ë©ˆì¶¤ (ì„±ëŠ¥ ìµœì í™”)
                }
            }
        });

        let isFirstLoad = true;

        async function updateData() {
            try {
                // 1. í†µê³„ & ì´ë²¤íŠ¸
                const dRes = await fetch('/api/dashboard-stats');
                const stats = await dRes.json();
                
                ['Z_IN', 'Z_SORT', 'Z_OUT'].forEach(id => {
                    const z = stats.zones.find(z => z.id === id);
                    if(z) document.getElementById(`count-${id}`).innerText = z.count;
                });
                
                const evtDiv = document.getElementById('event-list');
                evtDiv.innerHTML = '';
                stats.events.forEach(e => {
                    evtDiv.innerHTML += `<div class="event-item ${e.type}"><b>${e.type==='ERROR'?'âš  ì¥ì• ':'âœ¨ í”„ë¡œëª¨ì…˜'}</b><br>${e.desc}</div>`;
                });

                // 2. ê·¸ë˜í”„ ë°ì´í„°
                const gRes = await fetch('/api/graph-data');
                const gData = await gRes.json();
                
                if (gData.nodes.length > 0) {
                    nodes.update(gData.nodes);
                    edges.update(gData.edges);
                    
                    // [í•µì‹¬ í•´ê²°ì±…] ì²˜ìŒ ë¡œë”©ì‹œ ì¹´ë©”ë¼ë¥¼ ë…¸ë“œë“¤ì— ë§ì¶¤
                    if(isFirstLoad) {
                        network.fit({ animation: true });
                        isFirstLoad = false;
                    }
                }
            } catch(e) { console.error(e); }
        }
        
        // 2ì´ˆë§ˆë‹¤ ê°±ì‹ 
        setInterval(updateData, 2000);
        // ì´ˆê¸° ì‹¤í–‰
        updateData();

        window.selectZone = function(id) {
            document.querySelectorAll('.process-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${id}`).classList.add('active');
            network.selectNodes([id]);
            network.focus(id, { scale: 1.2, animation: true }); // ì„ íƒ ì‹œ í•´ë‹¹ êµ¬ì—­ ì¤Œì¸
        }

        async function send() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;
            
            const div = document.createElement('div'); div.className='msg user'; div.innerText=text;
            document.getElementById('messages').appendChild(div);
            input.value='';
            
            const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:text})});
            const data = await res.json();
            
            const botDiv = document.createElement('div'); botDiv.className='msg bot'; botDiv.innerHTML=data.reply;
            document.getElementById('messages').appendChild(botDiv);

            if(data.related_nodes && data.related_nodes.length > 0) {
                network.selectNodes(data.related_nodes);
                // AIê°€ ì°¾ì€ ë…¸ë“œë¡œ ì¤Œì¸
                network.fit({ nodes: data.related_nodes, animation: true });
            }
        }
    </script>
</body>
</html>
