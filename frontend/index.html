<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Korea Logistics Ontology View</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* ì™¼ìª½: ì˜¨í†¨ë¡œì§€ ë·° */
        #graph-panel { flex: 7; position: relative; background: #F8F9FA; border-right: 1px solid #ddd; }
        #network { width: 100%; height: 100%; }
        
        /* ìƒíƒœ ì˜¤ë²„ë ˆì´ (ë¬¼ë™ëŸ‰ í‘œì‹œ) */
        .status-overlay { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); pointer-events: none; }
        .status-item { margin: 5px 0; font-size: 14px; font-weight: bold; color: #333; }
        
        /* ì˜¤ë¥¸ìª½: ì±„íŒ… ë° ë¡œê·¸ */
        #side-panel { flex: 3; display: flex; flex-direction: column; background: white; }
        #log-box { flex: 4; padding: 20px; overflow-y: auto; border-bottom: 1px solid #eee; background: #FFF3E0; }
        #chat-box { flex: 6; display: flex; flex-direction: column; padding: 20px; }
        #messages { flex: 1; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fafafa; }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 15px; font-size: 14px; max-width: 80%; }
        .bot { background: #E3F2FD; align-self: flex-start; color: #1565C0; }
        .user { background: #FF6F00; align-self: flex-end; color: white; margin-left: auto; }
        #input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        
        /* ì•Œë¦¼ ë°°ì§€ */
        .badge-error { color: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="graph-panel">
        <div id="network"></div>
        <div class="status-overlay" id="overlay">
            <div class="status-item">ğŸ“¦ ì…ê³ (Inbound): <span id="val-Z_IN">0</span></div>
            <div class="status-item">ğŸ—ï¸ ë¶„ë¥˜(Sorting): <span id="val-Z_SORT">0</span></div>
            <div class="status-item">ğŸšš ì¶œê³ (Outbound): <span id="val-Z_OUT">0</span></div>
        </div>
    </div>

    <div id="side-panel">
        <div id="log-box">
            <h3 style="margin-top:0; color:#FF6F00;">ğŸ“¢ ì‹œìŠ¤í…œ ì•Œë¦¼</h3>
            <div id="event-logs"></div>
        </div>
        <div id="chat-box">
            <div id="messages">
                <div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! í•œêµ­ë¬¼ë¥˜ ê´€ì œ AIì…ë‹ˆë‹¤.<br>ê²€ìƒ‰í•˜ì‹œë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
            </div>
            <div id="input-area">
                <input type="text" id="chat-input" placeholder="ì˜ˆ: ì…ê³ ì¡´ ìƒíƒœ ì•Œë ¤ì¤˜" onkeypress="if(event.key==='Enter') send()">
            </div>
        </div>
    </div>

    <script>
        // Vis.js ë°ì´í„°ì…‹
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        let network = null;

        // ìƒ‰ìƒ ìƒìˆ˜
        const COLOR_DEFAULT = '#90A4AE'; // íšŒìƒ‰ (ê¸°ë³¸)
        const COLOR_CENTER = '#FF6F00';  // ì„¼í„° (ì˜¤ë Œì§€)
        const COLOR_ERROR = '#D32F2F';   // ì¥ì•  (ë¹¨ê°•)
        const COLOR_SEARCH = '#2962FF';  // ê²€ìƒ‰ (íŒŒë‘)

        // 1. [ì´ˆê¸°í™”] ì˜¨í†¨ë¡œì§€ êµ¬ì¡° ë¡œë“œ (í•œ ë²ˆë§Œ ì‹¤í–‰)
        async function initOntology() {
            const res = await fetch('/api/ontology-structure');
            const data = await res.json();

            const visNodes = data.nodes.map(n => ({
                id: n.id,
                label: n.label,
                group: n.group,
                color: n.group === 'Center' ? COLOR_CENTER : COLOR_DEFAULT,
                shape: n.group === 'Center' ? 'hexagon' : 'box',
                font: { color: 'white' },
                margin: 10
            }));

            const visEdges = data.edges.map(e => ({
                ...e, color: { color: '#CFD8DC' }, arrows: 'to'
            }));

            nodes.add(visNodes);
            edges.add(visEdges);

            const container = document.getElementById('network');
            network = new vis.Network(container, { nodes, edges }, {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD', // ìœ„ì—ì„œ ì•„ë˜ë¡œ
                        sortMethod: 'directed',
                        levelSeparation: 150,
                        nodeSpacing: 200
                    }
                },
                physics: false, // [ì¤‘ìš”] ë¬¼ë¦¬ ì—”ì§„ êº¼ì„œ í”ë“¤ë¦¼ ë°©ì§€
                interaction: { dragNodes: false, zoomView: true } // ë…¸ë“œ ë“œë˜ê·¸ ë§‰ìŒ (ê³ ì •)
            });
            
            // ë¡œë”© í›„ ì¤‘ì•™ ì •ë ¬
            setTimeout(() => network.fit(), 500);
        }

        // 2. [ì£¼ê¸°ì  ì‹¤í–‰] ìƒíƒœ ì—…ë°ì´íŠ¸ (ìƒ‰ìƒ & í…ìŠ¤íŠ¸ë§Œ ë³€ê²½)
        async function updateStatus() {
            try {
                const res = await fetch('/api/system-status');
                const status = await res.json();

                // (1) ë¬¼ë™ëŸ‰ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                for (const [zoneId, count] of Object.entries(status.counts)) {
                    const el = document.getElementById(`val-${zoneId}`);
                    if (el) el.innerText = count;
                }

                // (2) ë¡œê·¸ì°½ ì—…ë°ì´íŠ¸
                const logDiv = document.getElementById('event-logs');
                if (status.active_events.length > 0) {
                    logDiv.innerHTML = status.active_events.map(e => `<div class="badge-error">âš  ${e}</div>`).join('');
                } else {
                    logDiv.innerHTML = '<div style="color:#aaa;">í˜„ì¬ íŠ¹ì´ì‚¬í•­ ì—†ìŒ</div>';
                }

                // (3) ë…¸ë“œ ìƒ‰ìƒ ë³€ê²½ (ì—ëŸ¬ ì‹œ ë¹¨ê°•, ì•„ë‹ˆë©´ ì›ë˜ ìƒ‰ ë³µêµ¬)
                const allNodes = nodes.get();
                const updates = [];

                allNodes.forEach(node => {
                    // ê¸°ë³¸ ìƒ‰ìƒ ê²°ì •
                    let newColor = (node.group === 'Center') ? COLOR_CENTER : COLOR_DEFAULT;

                    // ì—ëŸ¬ ìƒíƒœë©´ ë¹¨ê°•ìœ¼ë¡œ ë®ì–´ì“°ê¸°
                    if (status.error_nodes.includes(node.id)) {
                        newColor = COLOR_ERROR;
                    }
                    
                    // í˜„ì¬ ìƒ‰ìƒê³¼ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸ (ê¹œë¹¡ì„ ë°©ì§€)
                    if (node.color !== newColor) {
                        updates.push({ id: node.id, color: newColor });
                    }
                });

                if (updates.length > 0) nodes.update(updates);

            } catch (e) { console.error(e); }
        }

        // 3. [ì±„íŒ… & ê²€ìƒ‰] ê²€ìƒ‰ ì‹œ í•´ë‹¹ ë…¸ë“œ ì¤Œì¸ + íŒŒë€ìƒ‰ í•˜ì´ë¼ì´íŠ¸
        async function send() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if (!text) return;

            // UI ë©”ì‹œì§€ ì¶”ê°€
            addMsg(text, 'user');
            input.value = '';

            const res = await fetch('/api/chat', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ message: text }) 
            });
            const data = await res.json();

            addMsg(data.reply, 'bot');

            // [ê²€ìƒ‰ íš¨ê³¼] ê´€ë ¨ ë…¸ë“œê°€ ìˆìœ¼ë©´ ì¤Œì¸ & ìƒ‰ìƒ ë³€ê²½
            if (data.related_nodes && data.related_nodes.length > 0) {
                const targetIds = data.related_nodes;
                
                // 1. ì¹´ë©”ë¼ ì´ë™
                network.fit({ nodes: targetIds, animation: true });

                // 2. ì ì‹œ íŒŒë€ìƒ‰ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸ í›„ ë³µêµ¬
                const originalColors = targetIds.map(id => ({ id: id, color: nodes.get(id).color }));
                const highlightUpdates = targetIds.map(id => ({ id: id, color: COLOR_SEARCH }));
                
                nodes.update(highlightUpdates);

                // 2ì´ˆ ë’¤ ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³µêµ¬
                setTimeout(() => {
                    nodes.update(originalColors);
                    // ì „ì²´ í™”ë©´ìœ¼ë¡œ ë‹¤ì‹œ ì¤Œì•„ì›ƒ (ì„ íƒì‚¬í•­)
                    // network.fit({ animation: true }); 
                }, 2000);
            }
        }

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = text;
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // ì‹¤í–‰
        initOntology();
        setInterval(updateStatus, 2000); // 2ì´ˆë§ˆë‹¤ ìƒíƒœ ì²´í¬

    </script>
</body>
</html>
