<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Smart Logistics Dashboard</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        :root { --primary: #FF6F00; --bg-body: #F0F2F5; --text-main: #333; }
        body { margin: 0; height: 100vh; display: flex; font-family: 'Pretendard', sans-serif; background: var(--bg-body); overflow: hidden; }

        /* ì™¼ìª½ ë©”ì¸ (ìƒíƒœì°½ + ê·¸ë˜í”„) */
        #main-container { flex: 7; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        
        /* 1. ìƒë‹¨ ì¹´ë“œ íŒ¨ë„ */
        #status-panel { height: 160px; background: white; display: flex; justify-content: center; align-items: center; gap: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .card { width: 160px; padding: 20px; border-radius: 16px; background: white; border: 2px solid #eee; text-align: center; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card.active { border-color: var(--primary); background: #FFF8E1; }
        .card-icon { font-size: 24px; color: var(--primary); margin-bottom: 10px; }
        .card-title { font-size: 14px; color: #666; font-weight: 600; }
        .card-value { font-size: 32px; font-weight: 800; color: #222; margin-top: 5px; }
        .arrow { color: #ccc; font-size: 20px; }

        /* 2. í•˜ë‹¨ ê·¸ë˜í”„ íŒ¨ë„ */
        #graph-panel { flex: 1; position: relative; background: #fafafa; }
        #network { width: 100%; height: 100%; }
        .graph-badge { position: absolute; top: 15px; left: 15px; background: white; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #555; }

        /* ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” (ë¡œê·¸ + ì±„íŒ…) */
        #sidebar { flex: 3; display: flex; flex-direction: column; background: white; }
        
        #log-section { height: 35%; padding: 20px; border-bottom: 1px solid #eee; overflow-y: auto; background: #fff; }
        #log-title { font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: var(--primary); }
        .log-item { padding: 12px; margin-bottom: 8px; border-radius: 8px; font-size: 13px; background: #f8f9fa; border-left: 4px solid #ddd; }
        .log-item.ERROR { background: #FFEBEE; border-left-color: #D32F2F; color: #B71C1C; }
        .log-item.PROMO { background: #F3E5F5; border-left-color: #7B1FA2; color: #4A148C; }

        #chat-section { flex: 1; display: flex; flex-direction: column; background: #f8f9fa; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
        .msg.bot { background: white; border: 1px solid #ddd; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        #chat-input-area { padding: 20px; background: white; border-top: 1px solid #eee; }
        #chat-input { width: 93%; padding: 14px; border: 1px solid #ddd; border-radius: 30px; outline: none; transition: 0.2s; }
        #chat-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(255, 111, 0, 0.1); }
    </style>
</head>
<body>

<div id="main-container">
    <div id="status-panel">
        <div class="card" id="card-Z_IN" onclick="focusNode('Z_IN')">
            <div class="card-icon"><i class="fas fa-dolly"></i></div>
            <div class="card-title">ì…ê³  (Inbound)</div>
            <div class="card-value" id="val-Z_IN">0</div>
        </div>
        <div class="arrow"><i class="fas fa-chevron-right"></i></div>
        <div class="card" id="card-Z_SORT" onclick="focusNode('Z_SORT')">
            <div class="card-icon"><i class="fas fa-boxes"></i></div>
            <div class="card-title">ë¶„ë¥˜ (Sorting)</div>
            <div class="card-value" id="val-Z_SORT">0</div>
        </div>
        <div class="arrow"><i class="fas fa-chevron-right"></i></div>
        <div class="card" id="card-Z_OUT" onclick="focusNode('Z_OUT')">
            <div class="card-icon"><i class="fas fa-truck-loading"></i></div>
            <div class="card-title">ì¶œê³  (Outbound)</div>
            <div class="card-value" id="val-Z_OUT">0</div>
        </div>
    </div>

    <div id="graph-panel">
        <div id="network"></div>
        <div class="graph-badge"><i class="fas fa-project-diagram"></i> ì‹¤ì‹œê°„ ì˜¨í†¨ë¡œì§€ ë·°</div>
    </div>
</div>

<div id="sidebar">
    <div id="log-section">
        <div id="log-title"><i class="fas fa-history"></i> ì‹¤ì‹œê°„ ì•Œë¦¼</div>
        <div id="log-list">
            <div style="color:#aaa; text-align:center; padding:20px;">ì‹œìŠ¤í…œ ì •ìƒ ê°€ë™ ì¤‘</div>
        </div>
    </div>
    
    <div id="chat-section">
        <div id="chat-messages">
            <div class="msg bot">ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”! ë¬¼ë¥˜ ê´€ì œ AIì…ë‹ˆë‹¤.<br>ì‹œìŠ¤í…œ ìƒíƒœë‚˜ ì¥ì•  ì›ì¸ì„ ë¬¼ì–´ë³´ì„¸ìš”.</div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter') sendChat()">
        </div>
    </div>
</div>

<script>
    // 1. [ì´ˆê°•ìˆ˜] ì¢Œí‘œ ì§ì ‘ ì§€ì • ë°ì´í„° (ì ˆëŒ€ ì‹¤íŒ¨ ì—†ìŒ)
    // ë¬¼ë¦¬ ì—”ì§„ì„ ë„ê³  ì´ ì¢Œí‘œëŒ€ë¡œ ê·¸ë¦½ë‹ˆë‹¤.
    const staticNodes = [
        { id: 'DT_HUB', label: 'ë™íƒ„ í—ˆë¸Œ\n(Center)', group: 'Center', x: 0, y: -150 },
        { id: 'Z_IN',   label: 'ì…ê³ ì¡´\n(Inbound)',   group: 'Zone',   x: -250, y: 50 },
        { id: 'Z_SORT', label: 'ë¶„ë¥˜ì¡´\n(Sorting)',   group: 'Zone',   x: 0,    y: 50 },
        { id: 'Z_OUT',  label: 'ì¶œê³ ì¡´\n(Outbound)',  group: 'Zone',   x: 250,  y: 50 },
        { id: 'AGV_01', label: 'AGV-01',             group: 'AGV',    x: -150, y: 150 },
        { id: 'AGV_02', label: 'AGV-02',             group: 'AGV',    x: 150,  y: 150 }
    ];

    const staticEdges = [
        { from: 'DT_HUB', to: 'Z_IN', arrows: 'to' },
        { from: 'DT_HUB', to: 'Z_SORT', arrows: 'to' },
        { from: 'DT_HUB', to: 'Z_OUT', arrows: 'to' },
        { from: 'Z_IN',   to: 'Z_SORT', arrows: 'to', label: 'NEXT' },
        { from: 'Z_SORT', to: 'Z_OUT', arrows: 'to', label: 'NEXT' },
        { from: 'AGV_01', to: 'Z_IN', dashes: true },
        { from: 'AGV_02', to: 'Z_SORT', dashes: true }
    ];

    // ìƒ‰ìƒ ì„¤ì •
    const COLORS = {
        Center: '#FF6F00', Zone: '#455A64', AGV: '#00897B', 
        Error: '#D32F2F', Highlight: '#2979FF', Default: '#90A4AE'
    };

    // Vis.js ì´ˆê¸°í™”
    const nodes = new vis.DataSet(staticNodes.map(n => ({
        ...n,
        shape: n.group === 'Center' ? 'hexagon' : (n.group === 'Zone' ? 'box' : 'dot'),
        color: { background: n.group === 'Center' ? COLORS.Center : COLORS.Zone, border: 'white' },
        font: { color: n.group === 'Center' ? 'white' : 'white' },
        size: 30,
        margin: 15,
        shadow: true
    })));
    
    const edges = new vis.DataSet(staticEdges.map(e => ({
        ...e, color: { color: '#B0BEC5' }, width: 2
    })));

    const container = document.getElementById('network');
    const network = new vis.Network(container, { nodes, edges }, {
        physics: false, // [ì¤‘ìš”] ë¬¼ë¦¬ ì—”ì§„ ë„ê¸° -> ì ˆëŒ€ ì›€ì§ì´ì§€ ì•ŠìŒ
        interaction: { dragNodes: false, zoomView: true, dragView: true }
    });
    
    // ì´ˆê¸° ì¹´ë©”ë¼ ë§ì¶¤
    network.fit();

    // 2. ë°ì´í„° ì—…ë°ì´íŠ¸ ë£¨í”„ (2ì´ˆ ê°„ê²©)
    async function updateData() {
        try {
            const res = await fetch('/api/system-status');
            const data = await res.json();

            // (1) ì¹´ë“œ ìˆ«ì ì—…ë°ì´íŠ¸
            for(const [id, count] of Object.entries(data.counts)) {
                const el = document.getElementById(`val-${id}`);
                if(el) el.innerText = count;
            }

            // (2) ë¡œê·¸ ì—…ë°ì´íŠ¸
            const logDiv = document.getElementById('log-list');
            if(data.events.length > 0) {
                logDiv.innerHTML = data.events.map(e => 
                    `<div class="log-item ${e.type}"><b>${e.type==='ERROR'?'âš  ì¥ì•  ë°œìƒ':'âœ¨ í”„ë¡œëª¨ì…˜'}</b><br>${e.desc}</div>`
                ).join('');
            } else {
                logDiv.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">ì‹œìŠ¤í…œ ì •ìƒ ê°€ë™ ì¤‘</div>';
            }

            // (3) ê·¸ë˜í”„ ìƒ‰ìƒ ë°˜ì˜ (ì¥ì•  ì‹œ ë¹¨ê°„ìƒ‰)
            const allNodes = nodes.get();
            const updates = [];
            
            allNodes.forEach(n => {
                let baseColor = (n.group === 'Center') ? COLORS.Center : COLORS.Zone;
                if(n.group === 'AGV') baseColor = COLORS.AGV;

                // ì¥ì• ê°€ ë°œìƒí•œ êµ¬ì—­(data.error_nodes)ì€ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ
                if(data.error_nodes.includes(n.id)) {
                    updates.push({ id: n.id, color: { background: COLORS.Error } });
                } else {
                    // ì›ë˜ ìƒ‰ ë³µêµ¬ (í•˜ì´ë¼ì´íŠ¸ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
                    if(n.color.background !== COLORS.Highlight && n.color.background !== baseColor) {
                        updates.push({ id: n.id, color: { background: baseColor } });
                    }
                }
            });
            if(updates.length > 0) nodes.update(updates);

        } catch(e) { console.error("Update Fail:", e); }
    }
    
    setInterval(updateData, 2000);

    // 3. UI ì¸í„°ë™ì…˜ (ì¹´ë“œ í´ë¦­ & ì±„íŒ…)
    window.focusNode = function(id) {
        // ì¹´ë“œ ìŠ¤íƒ€ì¼
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`card-${id}`);
        if(card) card.classList.add('active');

        // ê·¸ë˜í”„ ì¤Œ & í•˜ì´ë¼ì´íŠ¸
        network.fit({ nodes: [id], animation: true });
        
        // ê¹œë¹¡ì„ íš¨ê³¼
        const originalColor = nodes.get(id).color;
        nodes.update({ id: id, color: { background: COLORS.Highlight } });
        setTimeout(() => nodes.update({ id: id, color: originalColor }), 1500);
    }

    async function sendChat() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;

        addMsg(text, 'user');
        input.value = '';

        const loadId = addMsg('ë¶„ì„ ì¤‘...', 'bot', true);

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ message: text })
            });
            const data = await res.json();
            
            removeMsg(loadId);
            addMsg(data.reply, 'bot');

            if(data.related_nodes && data.related_nodes.length > 0) {
                focusNode(data.related_nodes[0]); // ì²« ë²ˆì§¸ ê´€ë ¨ ë…¸ë“œë¡œ ì´ë™
            }
        } catch(e) {
            removeMsg(loadId);
            addMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'bot');
        }
    }

    function addMsg(text, type, isTemp=false) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = text;
        div.id = isTemp ? 'temp-msg' : '';
        const box = document.getElementById('chat-messages');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        return div.id;
    }
    function removeMsg(id) {
        const el = document.getElementById(id);
        if(el) el.remove();
    }
</script>
</body>
</html>
