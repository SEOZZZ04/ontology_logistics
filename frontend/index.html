<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Logistics Command Center</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        /* Industrial Dark Theme */
        :root {
            --bg-dark: #121212;
            --bg-panel: #1E1E1E;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent-blue: #2196F3;
            --accent-red: #FF5252;
            --border-color: #333;
        }
        body { 
            display: flex; height: 100vh; margin: 0; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark); color: var(--text-primary);
            overflow: hidden;
        }
        #main-container { display: flex; width: 100%; height: 100%; }
        
        /* Left: Graph Area */
        #graph-panel { flex: 7; height: 100%; border-right: 2px solid var(--border-color); position: relative; }
        #graph-container { width: 100%; height: 100%; background: #191919; }
        .panel-title {
            position: absolute; top: 10px; left: 20px; 
            font-size: 1.2rem; font-weight: bold; color: var(--accent-blue);
            z-index: 10; text-transform: uppercase; letter-spacing: 1px;
        }

        /* Right: Sidebar */
        #sidebar { flex: 3; display: flex; flex-direction: column; height: 100%; background: var(--bg-panel); }

        /* Top-Right: Dashboard */
        #dashboard-panel { 
            flex: 4; padding: 20px; border-bottom: 2px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        .stat-card {
            background: #2C2C2C; padding: 15px; margin-bottom: 10px;
            border-radius: 4px; border-left: 4px solid var(--accent-blue);
        }
        .stat-card.alert { border-left-color: var(--accent-red); }
        .stat-title { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        #zone-stats-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;}
        .zone-stat { flex: 1; min-width: 80px; text-align: center; background:#252525; padding: 10px; border-radius:4px;}

        /* Bottom-Right: Chat */
        #chat-panel { flex: 6; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; background: #151515; }
        .msg { margin: 5px 0; padding: 10px 12px; border-radius: 4px; max-width: 80%; word-break: break-word;}
        .user { background: #0D47A1; align-self: flex-end; margin-left: auto; }
        .bot { background: #37474F; }
        #chat-input-container { display: flex; }
        #chat-input { 
            flex: 1; padding: 12px; font-size: 14px; 
            background: #2C2C2C; border: 1px solid var(--border-color); 
            color: var(--text-primary); outline: none;
        }
        #chat-input::placeholder { color: var(--text-secondary); }
        
        /* Vis.js Ïª§Ïä§ÌÖÄ Ïä§ÌÉÄÏùº */
        div.vis-network div.vis-navigation div.vis-button {
            background-color: var(--bg-panel);
            background-image: none;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="graph-panel">
            <div class="panel-title">üì° Real-time Logistics Ontology</div>
            <div id="graph-container"></div>
        </div>

        <div id="sidebar">
            <div id="dashboard-panel">
                <div class="panel-title" style="position:static; margin-bottom:15px;">üìä Operational Status</div>
                
                <div class="stat-card alert">
                    <div class="stat-title">Active Alerts (Events)</div>
                    <div class="stat-value" id="alert-count">0</div>
                </div>
                
                <div style="margin-top:10px; font-size:0.9rem; color:var(--text-secondary);">Zone Throughput (Items)</div>
                <div id="zone-stats-container">
                    </div>
            </div>

            <div id="chat-panel">
                <div class="panel-title" style="position:static; margin-bottom:15px;">ü§ñ AI Analyst</div>
                <div id="messages"></div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Î™ÖÎ†πÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 'ÌòÑÏû¨ Ïû•Ïï† ÌòÑÌô© Î≥¥Ïó¨Ï§ò')..." onkeypress="handleKey(event)">
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========================================
        // 1. Í∑∏ÎûòÌîÑ Ï¥àÍ∏∞Ìôî (Vis.js Settings)
        // =========================================
        const container = document.getElementById('graph-container');
        const nodesDS = new vis.DataSet([]);
        const edgesDS = new vis.DataSet([]);
        const data = { nodes: nodesDS, edges: edgesDS };

        const options = {
            nodes: {
                shape: 'dot',
                size: 20,
                font: { size: 14, color: '#E0E0E0', strokeWidth: 2, strokeColor: '#121212' },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                width: 2,
                shadow: false,
                smooth: { type: 'continuous' },
                arrows: { to: { enabled: true, scaleFactor: 0.5 } }
            },
            physics: {
                enabled: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    gravitationalConstant: -50,
                    centralGravity: 0.01,
                    springConstant: 0.08,
                    springLength: 100,
                    damping: 0.4,
                    avoidOverlap: 0.5
                },
                stabilization: {
                    enabled: true,
                    iterations: 1000,
                    updateInterval: 25,
                    onlyDynamicEdges: false,
                    fit: true
                }
            },
            interaction: { hover: true, tooltipDelay: 200, hideEdgesOnDrag: true }
        };
        const network = new vis.Network(container, data, options);
        
        network.once("stabilizationIterationsDone", function() {
            network.setOptions( { physics: false } );
        });


        // =========================================
        // 2. Îç∞Ïù¥ÌÑ∞ Ìè¥ÎßÅ (Í∑∏ÎûòÌîÑ & ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏)
        // =========================================
        let isHighlightActive = false;

        async function fetchData() {
            if (isHighlightActive) return;

            try {
                const graphRes = await fetch('/api/graph-data');
                const graphJson = await graphRes.json();
                nodesDS.update(graphJson.nodes);
                edgesDS.update(graphJson.edges);

                const dashRes = await fetch('/api/dashboard-stats');
                const dashJson = await dashRes.json();
                updateDashboard(dashJson);

            } catch (err) { console.error(err); }
        }

        function updateDashboard(data) {
            document.getElementById('alert-count').innerText = data.errors;
            
            const container = document.getElementById('zone-stats-container');
            container.innerHTML = '';
            data.zones.forEach(z => {
                const div = document.createElement('div');
                div.className = 'zone-stat stat-card';
                div.style.borderLeftColor = '#0277BD';
                div.innerHTML = `<div class="stat-title">${z.name}</div><div class="stat-value">${z.count}</div>`;
                container.appendChild(div);
            });
        }
        
        setInterval(fetchData, 3000);
        fetchData();


        // =========================================
        // 3. Ï±ÑÌåÖ & Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÌïòÏù¥ÎùºÏù¥ÌåÖ Î°úÏßÅ
        // =========================================
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';
            addMessage('Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...', 'bot', true); 

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: text})
                });
                const json = await res.json();
                
                // [ÏàòÏ†ïÎê®] ÌååÏù¥Ïç¨ Ï£ºÏÑù(#)ÏùÑ ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ Ï£ºÏÑù(//)ÏúºÎ°ú Î≥ÄÍ≤Ω
                document.getElementById('messages').lastChild.remove(); 
                addMessage(json.reply, 'bot');

                if (json.related_nodes && json.related_nodes.length > 0) {
                    highlightNodes(json.related_nodes);
                } else {
                    resetHighlight();
                }

            } catch (e) {
                if(document.getElementById('messages').lastChild) {
                    document.getElementById('messages').lastChild.textContent = "ÏóêÎü¨Í∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
                }
                resetHighlight();
                console.error(e);
            }
        }

        function highlightNodes(relatedIds) {
            isHighlightActive = true;
            const allNodes = nodesDS.get();
            const updateArray = [];
            const highlightIdsSet = new Set(relatedIds);

            allNodes.forEach(node => {
                if (highlightIdsSet.has(node.id)) {
                    updateArray.push({
                        id: node.id,
                        color: { background: '#FFFFFF', border: '#FFD700' },
                        font: { size: 18, color: '#FFFFFF', background: '#000000' },
                        shadow: { enabled: true, color: 'rgba(255,215,0,0.8)', size: 20 }
                    });
                } else {
                    updateArray.push({
                        id: node.id,
                        color: { background: '#333333', border: '#222222' },
                        font: { color: '#555555' },
                        shadow: { enabled: false }
                    });
                }
            });
            nodesDS.update(updateArray);
            
            if (relatedIds.length > 0) {
                network.fit({ nodes: relatedIds, animation: true });
            }
        }

        function resetHighlight() {
            isHighlightActive = false;
             fetchData(); 
             network.fit({ animation: true });
        }

        function addMessage(text, sender, isTemp=false) {
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerText = text;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function handleKey(e) { if (e.key === 'Enter') sendMessage(); }
    </script>
</body>
</html>
