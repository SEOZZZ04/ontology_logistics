<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toss Logistics Digital Twin</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        :root {
            /* Toss & Dark Theme Colors */
            --toss-blue: #3182F6;
            --toss-bg: #0C151C; /* 깊은 남색 계열 */
            --toss-card: #17202A;
            --text-white: #FFFFFF;
            --text-gray: #B0B8C1;
            --success: #34C759;
            --error: #FF3B30;
            --promo-glow: 0 0 30px rgba(49, 130, 246, 0.4);
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--toss-bg);
            font-family: 'Pretendard', sans-serif;
            color: var(--text-white);
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* === [왼쪽] 메인 관제 화면 === */
        #main-view {
            flex: 1; position: relative;
            background: radial-gradient(circle at 50% 50%, #1c2533 0%, #0C151C 100%);
            display: flex; flex-direction: column;
        }

        /* 헤더 */
        header {
            padding: 24px 32px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }
        .title { font-size: 24px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .title i { color: var(--toss-blue); }
        
        /* 상태 배지 */
        .badge {
            padding: 8px 16px; border-radius: 24px; font-size: 14px; font-weight: 700;
            display: flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
        }
        .badge.active { color: var(--success); background: rgba(52, 199, 89, 0.15); }
        .badge.error { color: var(--error); background: rgba(255, 59, 48, 0.15); animation: blink 1s infinite; }
        .badge.promo { color: #A64DFF; background: rgba(166, 77, 255, 0.15); border: 1px solid #A64DFF; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* 그래프 컨테이너 */
        #network { flex: 1; width: 100%; height: 100%; }

        /* === [오른쪽] 사이드바 === */
        #sidebar {
            width: 380px;
            background: var(--toss-card);
            border-left: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column;
            box-shadow: -20px 0 50px rgba(0,0,0,0.5);
            z-index: 20;
        }

        /* 통계 패널 */
        .stats-panel { padding: 30px 24px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .panel-label { color: var(--text-gray); font-size: 14px; font-weight: 600; margin-bottom: 16px; }
        .stat-grid { display: flex; justify-content: space-between; gap: 10px; }
        .stat-box { 
            flex: 1; background: rgba(255,255,255,0.03); 
            border-radius: 16px; padding: 16px; text-align: center; cursor: pointer;
            transition: 0.2s;
        }
        .stat-box:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); }
        .stat-num { font-size: 28px; font-weight: 800; color: var(--toss-blue); margin-bottom: 4px; }
        .stat-name { font-size: 13px; color: var(--text-gray); }

        /* 채팅 UI */
        #chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding-bottom: 20px; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        
        .msg { max-width: 85%; padding: 14px 18px; border-radius: 20px; font-size: 15px; line-height: 1.5; word-break: keep-all; }
        .msg.bot { 
            background: #2C353F; color: var(--text-white); align-self: flex-start; 
            border-top-left-radius: 4px; 
        }
        .msg.user { 
            background: var(--toss-blue); color: white; align-self: flex-end; 
            border-top-right-radius: 4px; font-weight: 600;
        }

        /* 입력창 */
        .input-area { padding: 0 20px; display: flex; gap: 10px; }
        .input-box {
            flex: 1; background: #252D37; border: none; border-radius: 24px;
            padding: 14px 20px; color: white; font-size: 15px; outline: none;
        }
        .send-btn {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background: var(--toss-blue); color: white; font-size: 18px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .send-btn:hover { background: #1b64da; transform: scale(1.05); }

        /* 프로모션 효과 */
        body.promo-mode #main-view { box-shadow: inset 0 0 100px rgba(166, 77, 255, 0.1); }
        body.promo-mode .stat-num { color: #A64DFF; }

    </style>
</head>
<body>

<div id="main-view">
    <header>
        <div class="title"><i class="fas fa-boxes-stacked"></i> 물류 관제 센터</div>
        <div style="display:flex; gap:10px;">
            <div id="badge-promo" class="badge promo" style="display:none;"><i class="fas fa-bolt"></i> 주문 폭주 중!</div>
            <div id="badge-error" class="badge error" style="display:none;"><i class="fas fa-triangle-exclamation"></i> 설비 장애</div>
            <div id="badge-norm" class="badge active"><i class="fas fa-circle-check"></i> 정상 가동 중</div>
        </div>
    </header>

    <div id="network"></div>
</div>

<div id="sidebar">
    <div class="stats-panel">
        <div class="panel-label">실시간 물동량</div>
        <div class="stat-grid">
            <div class="stat-box" onclick="focusNode('Z_IN')">
                <div class="stat-num" id="cnt-Z_IN">0</div>
                <div class="stat-name">입고 대기</div>
            </div>
            <div class="stat-box" onclick="focusNode('Z_SORT')">
                <div class="stat-num" id="cnt-Z_SORT">0</div>
                <div class="stat-name">분류 처리</div>
            </div>
            <div class="stat-box" onclick="focusNode('Z_OUT')">
                <div class="stat-num" id="cnt-Z_OUT">0</div>
                <div class="stat-name">출고 대기</div>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-msgs">
            <div class="msg bot">
                안녕하세요! 실시간 물류 관제 AI입니다.<br>
                "현재 주문 폭주 상태야?" 처럼 편하게 물어보세요.
            </div>
        </div>
        <div class="input-area">
            <input type="text" class="input-box" id="chat-input" placeholder="질문 입력..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="send-btn" onclick="sendMsg()"><i class="fas fa-arrow-up"></i></button>
        </div>
    </div>
</div>

<script>
    /* === 1. Vis.js 그래프 초기화 (좌표 고정) === */
    const container = document.getElementById('network');
    
    const nodes = new vis.DataSet([
        { id: 'Z_IN', label: '입고존', x: -300, y: 0, group: 'zone' },
        { id: 'Z_SORT', label: '분류존', x: 0, y: 0, group: 'zone' },
        { id: 'Z_OUT', label: '출고존', x: 300, y: 0, group: 'zone' },
        // AGV와 트럭은 동적으로 제어
    ]);

    const edges = new vis.DataSet([
        { from: 'Z_IN', to: 'Z_SORT', arrows: 'to', dashes:true, color: {color:'#333D4B'} },
        { from: 'Z_SORT', to: 'Z_OUT', arrows: 'to', dashes:true, color: {color:'#333D4B'} }
    ]);

    const options = {
        nodes: {
            font: { face: 'Pretendard', color: '#fff', size: 16, multi: true, vadjust: -35 },
            borderWidth: 0, shadow: true
        },
        groups: {
            zone: { 
                shape: 'dot', size: 25, 
                color: { background: '#191F28', border: '#3182F6' },
                borderWidth: 3
            },
            agv: { 
                shape: 'icon', 
                icon: { face: '"Font Awesome 6 Free"', code: '\uf472', size: 40, color: '#3182F6' } // 파란 AGV
            },
            truck: {
                shape: 'icon',
                icon: { face: '"Font Awesome 6 Free"', code: '\uf0d1', size: 50, color: '#FFFFFF' } // 흰색 트럭
            },
            highlight: {
                color: { background: '#3182F6', border: '#fff' }, size: 35
            }
        },
        physics: false, // 애니메이션을 위해 물리 엔진 끄기
        interaction: { hover: true, zoomView: true }
    };

    const network = new vis.Network(container, { nodes, edges }, options);
    network.fit(); // 초기 줌 맞춤

    /* === 2. 실시간 데이터 & 애니메이션 루프 === */
    let lastData = null;

    async function fetchData() {
        try {
            const res = await fetch('/api/system-status');
            lastData = await res.json(); // 데이터 저장
            
            // UI 업데이트
            updateUI(lastData);
        } catch(e) { console.error(e); }
    }

    function updateUI(data) {
        // 1. 숫자 업데이트
        for(const [k, v] of Object.entries(data.counts)) {
            const el = document.getElementById(`cnt-${k}`);
            if(el) el.innerText = v;
        }

        // 2. 이벤트 상태 (프로모션/에러)
        const isError = data.events.length && data.events[0].type === 'ERROR';
        const isPromo = data.events.length && data.events[0].type === 'PROMO';

        document.getElementById('badge-error').style.display = isError ? 'flex' : 'none';
        document.getElementById('badge-promo').style.display = isPromo ? 'flex' : 'none';
        document.getElementById('badge-norm').style.display = (!isError && !isPromo) ? 'flex' : 'none';

        if(isPromo) document.body.classList.add('promo-mode');
        else document.body.classList.remove('promo-mode');
    }

    // 애니메이션 루프 (60fps)
    function animate() {
        if(!lastData) {
            requestAnimationFrame(animate);
            return;
        }

        const now = Date.now() / 1000.0; // 현재 시간 (초)
        const updates = [];

        // AGV 이동 보간
        lastData.agvs.forEach(agv => {
            let x = 0, y = 0;
            const srcNode = nodes.get(agv.source);
            const dstNode = nodes.get(agv.target);

            if(srcNode && dstNode && agv.status === 'MOVING') {
                // 진행률 계산 (부드러운 이동)
                // backend의 start_time과 duration 이용
                // agv.progress는 이미 백엔드에서 오지만, 프론트에서 더 부드럽게 하려면:
                // 여기서는 백엔드가 주는 progress(0~1)를 보완하거나 직접 사용
                
                // 백엔드 progress가 interval 때문에 끊기므로, 직접 보간은 복잡함.
                // 따라서 단순하게 백엔드 progress를 목표로 하되, css transition처럼 부드럽게?
                // Vis.js는 좌표 직접 수정이 답.
                
                // 그냥 백엔드 progress 사용 (0.5초마다 갱신되므로 약간 끊길 수 있음 -> 보완 로직 필요하지만 생략)
                // 대신 트릭: AGV 아이콘을 흔들어줌
                
                const t = agv.progress;
                x = srcNode.x + (dstNode.x - srcNode.x) * t;
                y = srcNode.y + (dstNode.y - srcNode.y) * t;
                
                // 살짝 위로 띄움 (겹침 방지)
                y += 40; 
            } else if (srcNode) {
                x = srcNode.x;
                y = srcNode.y + 40;
            }

            // 노드 없으면 생성
            if(!nodes.get(agv.id)) {
                nodes.add({ id: agv.id, group: 'agv', label: agv.id, x, y });
            } else {
                updates.push({ id: agv.id, x, y });
            }
        });

        // 트럭 로직 (간단 구현)
        // 트럭 상태가 오지 않으면 기본값(화면 밖)
        // 실제로는 백엔드에서 트럭 위치 정보도 주는게 좋음. 
        // 여기선 하드코딩된 'TRUCK' 노드를 활용한다고 가정 (백엔드에 추가 필요하지만 시각화만 처리)
        // 만약 트럭이 Z_OUT에 뭔가 하고 있다면:
        const truckX = (lastData.counts['Z_OUT'] > 2) ? 380 : 500; // 물건 많으면 옴
        if(!nodes.get('TRUCK')) {
             nodes.add({ id: 'TRUCK', group: 'truck', label: '배송차량', x: 500, y: 0 });
        }
        
        // 트럭 부드럽게 이동 (현재 위치에서 목표 위치로)
        const trk = nodes.get('TRUCK');
        const dx = truckX - trk.x;
        if(Math.abs(dx) > 1) {
            updates.push({ id: 'TRUCK', x: trk.x + dx * 0.05 }); // 감속 이동
        }

        if(updates.length) nodes.update(updates);
        requestAnimationFrame(animate);
    }

    // 데이터 주기는 0.5초, 애니메이션은 60fps
    setInterval(fetchData, 500);
    requestAnimationFrame(animate);

    /* === 3. 채팅 기능 === */
    async function sendMsg() {
        const inp = document.getElementById('chat-input');
        const txt = inp.value.trim();
        if(!txt) return;

        addChat(txt, 'user');
        inp.value = '';

        try {
            const res = await fetch('/api/chat', {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:txt})
            });
            const d = await res.json();
            addChat(d.reply, 'bot');

            if(d.related_nodes && d.related_nodes.length) {
                // 줌인 효과
                network.fit({ nodes: d.related_nodes, animation: true });
                const ups = d.related_nodes.map(id => ({id, group:'highlight'}));
                nodes.update(ups);
                setTimeout(() => {
                    // 원래대로 복구 (그룹 추론)
                    const resets = d.related_nodes.map(id => ({
                        id, 
                        group: id.startsWith('A')?'agv':(id.startsWith('Z')?'zone':'truck')
                    }));
                    nodes.update(resets);
                }, 2000);
            }
        } catch(e) { addChat('오류가 발생했습니다.', 'bot'); }
    }

    function addChat(txt, type) {
        const box = document.getElementById('chat-msgs');
        const d = document.createElement('div');
        d.className = `msg ${type}`;
        d.innerHTML = txt;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    }

    function focusNode(id) {
        network.focus(id, { scale: 1.2, animation: true });
    }
</script>
</body>
</html>
