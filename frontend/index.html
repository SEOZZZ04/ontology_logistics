<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Korea Logistics AI Dashboard</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    
    <style>
        :root { --primary: #FF6F00; --bg-body: #F5F7FA; --bg-card: #FFFFFF; --text-main: #263238; --border: #ECEFF1; }
        body { margin: 0; height: 100vh; display: flex; font-family: 'Pretendard', sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }
        
        /* ì™¼ìª½ ë©”ì¸ ì˜ì—­ */
        #main-view { flex: 7; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        
        /* 1. ìƒë‹¨ í”„ë¡œì„¸ìŠ¤ íŒ¨ë„ (ì¹´ë“œ UI ë³µêµ¬) */
        #top-process-panel { height: 140px; background: var(--bg-card); padding: 0 20px; display: flex; justify-content: center; align-items: center; gap: 30px; border-bottom: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        
        .process-card { background: white; border: 2px solid var(--border); border-radius: 12px; width: 150px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; }
        .process-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .process-card.active { border-color: var(--primary); background: #FFF8E1; }
        .p-icon { font-size: 1.5rem; color: var(--primary); margin-bottom: 5px; }
        .p-title { font-weight: bold; font-size: 0.9rem; color: #546E7A; }
        .p-count { font-size: 2rem; font-weight: 800; margin-top: 5px; color: #263238; }
        
        .arrow-divider { color: #CFD8DC; font-size: 1.2rem; }

        /* 2. í•˜ë‹¨ ê·¸ë˜í”„ íŒ¨ë„ */
        #bottom-graph-panel { flex: 1; position: relative; background: #FAFAFA; }
        #graph-container { width: 100%; height: 100%; }
        
        /* ì˜¨í†¨ë¡œì§€ ë¼ë²¨ */
        .graph-label { position: absolute; top: 15px; left: 15px; background: white; padding: 8px 12px; border-radius: 20px; border: 1px solid #CFD8DC; font-size: 0.85rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #455A64; display: flex; align-items: center; gap: 5px; }

        /* ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” (ì±„íŒ…/ë¡œê·¸) */
        #sidebar { flex: 3; display: flex; flex-direction: column; background: var(--bg-card); border-left: 1px solid var(--border); }
        
        #info-panel { height: 30%; padding: 20px; border-bottom: 1px solid var(--border); overflow-y: auto; background: #FFF; }
        #info-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        
        #chat-panel { height: 70%; display: flex; flex-direction: column; background: #F5F7FA; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bot { background: white; border: 1px solid #E0E0E0; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        #input-area { padding: 15px; background: white; border-top: 1px solid #E0E0E0; }
        #chat-input { width: 93%; padding: 12px; border: 1px solid #CFD8DC; border-radius: 25px; outline: none; transition: 0.2s; font-family: inherit; }
        #chat-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(255, 111, 0, 0.1); }

        /* ì´ë²¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .event-item { padding: 12px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; border-left: 4px solid #ccc; background: #f9f9f9; }
        .event-item.ERROR { border-left-color: #D32F2F; background: #FFEBEE; color: #C62828; font-weight: bold; animation: pulse 2s infinite; }
        .event-item.PROMO { border-left-color: #7B1FA2; background: #F3E5F5; color: #6A1B9A; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="main-view">
        <div id="top-process-panel">
            <div class="process-card" onclick="focusZone('Z_IN')" id="card-Z_IN">
                <div class="p-icon"><i class="fas fa-dolly"></i></div>
                <div class="p-title">ì…ê³ (Inbound)</div>
                <div class="p-count" id="count-Z_IN">0</div>
            </div>
            <i class="fas fa-arrow-right arrow-divider"></i>
            <div class="process-card" onclick="focusZone('Z_SORT')" id="card-Z_SORT">
                <div class="p-icon"><i class="fas fa-boxes"></i></div>
                <div class="p-title">ë¶„ë¥˜(Sorting)</div>
                <div class="p-count" id="count-Z_SORT">0</div>
            </div>
            <i class="fas fa-arrow-right arrow-divider"></i>
            <div class="process-card" onclick="focusZone('Z_OUT')" id="card-Z_OUT">
                <div class="p-icon"><i class="fas fa-truck-loading"></i></div>
                <div class="p-title">ì¶œê³ (Outbound)</div>
                <div class="p-count" id="count-Z_OUT">0</div>
            </div>
        </div>

        <div id="bottom-graph-panel">
            <div id="graph-container"></div>
            <div class="graph-label"><i class="fas fa-project-diagram"></i> ì‹¤ì‹œê°„ ì˜¨í†¨ë¡œì§€ (Live Ontology)</div>
        </div>
    </div>

    <div id="sidebar">
        <div id="info-panel">
            <div id="info-title"><i class="fas fa-bullhorn"></i> ì‹œìŠ¤í…œ ì•Œë¦¼</div>
            <div id="event-list">
                <div style="color:#B0BEC5; font-size:0.85rem;">í˜„ì¬ ë°œìƒí•œ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
        
        <div id="chat-panel">
            <div id="messages">
                <div class="msg bot">ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”! í•œêµ­ë¬¼ë¥˜ ê´€ì œ AIì…ë‹ˆë‹¤.<br>ë¬¼ë¥˜ì„¼í„° ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§ ì¤‘ì…ë‹ˆë‹¤. ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”!</div>
            </div>
            <div id="input-area">
                <input type="text" id="chat-input" placeholder="ì˜ˆ: í˜„ì¬ ì¥ì•  ìƒí™© ì•Œë ¤ì¤˜" onkeypress="if(event.key==='Enter') sendMessage()">
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let network = null;
        let nodes = new vis.DataSet([]);
        let edges = new vis.DataSet([]);
        
        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const COLORS = {
            center: '#FF6F00',
            zone: '#FF9800',
            agv: '#009688',
            error: '#D32F2F',
            search: '#2979FF',
            default: '#90A4AE'
        };

        // 1. ì˜¨í†¨ë¡œì§€ ì´ˆê¸°í™” (êµ¬ì¡° ë¡œë“œ)
        async function initGraph() {
            try {
                const res = await fetch('/api/ontology-structure');
                const data = await res.json();
                
                // ë…¸ë“œ ë°ì´í„° ê°€ê³µ
                const visNodes = data.nodes.map(n => ({
                    id: n.id,
                    label: n.label,
                    group: n.group,
                    shape: n.group === 'Center' ? 'hexagon' : (n.group === 'Zone' ? 'box' : 'dot'),
                    color: n.group === 'Center' ? COLORS.center : (n.group === 'Zone' ? COLORS.zone : COLORS.agv),
                    font: { color: n.group === 'Center' ? 'white' : 'black', size: 16 },
                    margin: 12,
                    borderWidth: 2,
                    shadow: true
                }));

                // ì—£ì§€ ë°ì´í„° ê°€ê³µ
                const visEdges = data.edges.map(e => ({
                    ...e, 
                    arrows: 'to', 
                    color: { color: '#CFD8DC' }, 
                    width: 2 
                }));

                nodes.add(visNodes);
                edges.add(visEdges);

                const container = document.getElementById('graph-container');
                
                // [í•µì‹¬] ë ˆì´ì•„ì›ƒ ì„¤ì • ê°œì„ 
                const options = {
                    layout: {
                        hierarchical: {
                            enabled: true,
                            direction: 'UD', // ìœ„->ì•„ë˜
                            sortMethod: 'directed',
                            levelSeparation: 150, // ì¸µ ê°„ê²© ë„“í˜
                            nodeSpacing: 250,     // ë…¸ë“œ ì¢Œìš° ê°„ê²© ë„“í˜ (ê²¹ì¹¨ ë°©ì§€)
                            treeSpacing: 250
                        }
                    },
                    physics: {
                        enabled: true,
                        hierarchicalRepulsion: {
                            nodeDistance: 250,
                            springLength: 150,
                        },
                        // [ì¤‘ìš”] ì´ˆê¸° ì•ˆì •í™” í›„ ë¬¼ë¦¬ ì—”ì§„ ì •ì§€ (ê¹”ë”í•œ ë°°ì¹˜ í›„ ê³ ì •)
                        stabilization: {
                            enabled: true,
                            iterations: 200, // ì¶©ë¶„íˆ ê³„ì‚°
                            updateInterval: 25,
                            onlyDynamicEdges: false,
                            fit: true
                        }
                    },
                    interaction: {
                        dragNodes: false, // ì‚¬ìš©ì ë“œë˜ê·¸ ë°©ì§€ (ìœ„ì¹˜ ê³ ì •)
                        zoomView: true,
                        dragView: true
                    }
                };

                network = new vis.Network(container, { nodes, edges }, options);

                // ì•ˆì •í™”ê°€ ëë‚˜ë©´ ë¬¼ë¦¬ ì—”ì§„ ë„ê¸° (í”ë“¤ë¦¼ ë°©ì§€)
                network.on("stabilizationIterationsDone", function () {
                    network.setOptions({ physics: { enabled: false } });
                    console.log("Layout stabilized and frozen.");
                });

            } catch (e) {
                console.error("Graph init failed:", e);
            }
        }

        // 2. ì£¼ê¸°ì  ìƒíƒœ ì—…ë°ì´íŠ¸ (2ì´ˆë§ˆë‹¤)
        async function updateStatus() {
            try {
                const res = await fetch('/api/system-status');
                const status = await res.json();

                // (1) ìƒë‹¨ ì¹´ë“œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                for (const [zoneId, count] of Object.entries(status.counts)) {
                    const el = document.getElementById(`count-${zoneId}`);
                    if (el) el.innerText = count;
                }

                // (2) ì•Œë¦¼ì°½ ì—…ë°ì´íŠ¸
                const logDiv = document.getElementById('event-list');
                if (status.active_events.length > 0) {
                    logDiv.innerHTML = status.active_events.map(desc => 
                        `<div class="event-item ERROR"><i class="fas fa-exclamation-triangle"></i> ${desc}</div>`
                    ).join('');
                } else {
                    logDiv.innerHTML = '<div style="color:#B0BEC5; font-size:0.85rem; padding:10px;">í˜„ì¬ ì‹œìŠ¤í…œì´ ì •ìƒ ê°€ë™ ì¤‘ì…ë‹ˆë‹¤.</div>';
                }

                // (3) ê·¸ë˜í”„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (ì—ëŸ¬ ì‹œ ë¹¨ê°•)
                const allNodes = nodes.get();
                const updates = [];
                
                allNodes.forEach(node => {
                    let targetColor = COLORS.default;
                    if (node.group === 'Center') targetColor = COLORS.center;
                    else if (node.group === 'Zone') targetColor = COLORS.zone;
                    else if (node.group === 'AGV') targetColor = COLORS.agv;

                    // ì—ëŸ¬ ë°œìƒ ì‹œ
                    if (status.error_nodes.includes(node.id)) {
                        targetColor = COLORS.error;
                    }

                    // ìƒ‰ìƒì´ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
                    if (node.color !== targetColor) {
                        updates.push({ id: node.id, color: targetColor });
                    }
                });

                if (updates.length > 0) nodes.update(updates);

            } catch (e) { console.error("Update failed:", e); }
        }

        // 3. ì±„íŒ… ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage(text, 'user');
            input.value = '';

            // ë¡œë”© í‘œì‹œ
            const loadingId = addMessage('ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...', 'bot', true);

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();

                // ë¡œë”© ë©”ì‹œì§€ ì œê±° í›„ ì‘ë‹µ í‘œì‹œ
                removeMessage(loadingId);
                addMessage(data.reply, 'bot');

                // ê´€ë ¨ ë…¸ë“œ ì¤Œì¸ íš¨ê³¼
                if (data.related_nodes && data.related_nodes.length > 0) {
                    focusNodes(data.related_nodes);
                }

            } catch (e) {
                removeMessage(loadingId);
                addMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'bot');
                console.error(e);
            }
        }

        // ìœ í‹¸: ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(text, type, isLoading = false) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = isLoading ? `<i class="fas fa-spinner fa-spin"></i> ${text}` : text;
            const id = 'msg-' + Date.now();
            div.id = id;
            
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // ìœ í‹¸: ë…¸ë“œ ì¤Œì¸ ë° í•˜ì´ë¼ì´íŠ¸
        function focusNodes(nodeIds) {
            if (!network) return;
            
            // 1. ì¹´ë©”ë¼ ì´ë™
            network.fit({ nodes: nodeIds, animation: true });

            // 2. íŒŒë€ìƒ‰ í•˜ì´ë¼ì´íŠ¸
            const originalColors = nodeIds.map(id => ({ id: id, color: nodes.get(id).color }));
            const highlightUpdates = nodeIds.map(id => ({ id: id, color: COLORS.search }));
            
            nodes.update(highlightUpdates);

            // 1.5ì´ˆ í›„ ë³µêµ¬
            setTimeout(() => {
                nodes.update(originalColors);
                network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } }); // ì „ì²´ í™”ë©´ ë³µê·€
            }, 1500);
        }

        // ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ êµ¬ì—­ ì¤Œì¸
        window.focusZone = function(zoneId) {
            // ì¹´ë“œ í™œì„±í™” ìŠ¤íƒ€ì¼
            document.querySelectorAll('.process-card').forEach(c => c.classList.remove('active'));
            const card = document.getElementById(`card-${zoneId}`);
            if(card) card.classList.add('active');
            
            focusNodes([zoneId]);
        }

        // ì‹¤í–‰
        initGraph();
        setInterval(updateStatus, 2000);

    </script>
</body>
</html>
