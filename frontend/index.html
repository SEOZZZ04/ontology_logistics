<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Korea Logistics AI</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [í…Œë§ˆ] í•œêµ­ë¬¼ë¥˜ (Korea Logistics) - Clean Orange & White */
        :root {
            --primary: #FF6F00; /* í•œêµ­ë¬¼ë¥˜ ë©”ì¸ ì»¬ëŸ¬ (Deep Orange) */
            --bg-body: #F5F7FA;
            --bg-card: #FFFFFF;
            --text-main: #263238;
            --text-sub: #78909C;
            --border: #ECEFF1;
            --shadow: 0 4px 6px rgba(0,0,0,0.04);
        }

        body {
            margin: 0; height: 100vh; display: flex;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: var(--bg-body); color: var(--text-main);
        }

        /* ì™¼ìª½: ë©”ì¸ (ìƒë‹¨ í”„ë¡œì„¸ìŠ¤ + í•˜ë‹¨ ê·¸ë˜í”„) */
        #main-view { flex: 7; display: flex; flex-direction: column; height: 100%; border-right: 1px solid var(--border); }
        
        /* [ìƒë‹¨] í”„ë¡œì„¸ìŠ¤ ë·° */
        #top-process-panel {
            flex: 3; background: var(--bg-card); padding: 20px;
            display: flex; align-items: center; justify-content: center; gap: 40px;
            border-bottom: 1px solid var(--border);
        }
        
        .process-card {
            background: white; border: 2px solid var(--border); border-radius: 12px;
            width: 180px; padding: 25px 15px; text-align: center;
            box-shadow: var(--shadow); transition: all 0.2s; cursor: pointer;
        }
        .process-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .process-card.active { border-color: var(--primary); background: #FFF8E1; }
        
        .p-icon { font-size: 2.2rem; color: var(--primary); margin-bottom: 15px; }
        .p-title { font-size: 1.1rem; font-weight: bold; color: var(--text-main); margin-bottom: 5px; }
        .p-count { font-size: 2.2rem; font-weight: 800; color: var(--text-main); }
        .p-desc { font-size: 0.8rem; color: var(--text-sub); margin-top: 5px; text-transform: uppercase; letter-spacing: 1px;}
        
        .arrow { font-size: 1.2rem; color: #CFD8DC; }

        /* [í•˜ë‹¨] ì˜¨í†¨ë¡œì§€ ê·¸ë˜í”„ */
        #bottom-graph-panel { flex: 7; position: relative; background: #FAFAFA; }
        #graph-container { width: 100%; height: 100%; }
        .panel-label {
            position: absolute; top: 20px; left: 25px; z-index: 10;
            background: white; padding: 8px 16px; border: 1px solid var(--border);
            border-radius: 20px; font-weight: bold; color: var(--text-main); font-size: 0.9rem;
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 8px;
        }

        /* ì˜¤ë¥¸ìª½: ì‚¬ì´ë“œë°” */
        #sidebar { flex: 3; display: flex; flex-direction: column; background: var(--bg-card); }
        
        /* ì •ë³´ì°½ */
        #info-panel { flex: 4; padding: 25px; border-bottom: 1px solid var(--border); overflow-y: auto; }
        .info-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .event-item {
            background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-size: 0.95rem;
            border: 1px solid var(--border); border-left: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .event-item.error { border-left-color: #D32F2F; background: #FFEBEE; }
        
        /* ì±„íŒ…ì°½ */
        #chat-panel { flex: 6; display: flex; flex-direction: column; padding: 20px; background: #F5F7FA; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; }
        .msg { padding: 12px 16px; margin: 8px 0; border-radius: 12px; max-width: 85%; font-size: 0.95rem; line-height: 1.5; }
        .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bot { background: white; border: 1px solid #CFD8DC; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        #input-area { display: flex; gap: 10px; margin-top: 10px;}
        #chat-input {
            flex: 1; padding: 14px; border: 1px solid #CFD8DC; border-radius: 25px; outline: none; transition: border 0.2s;
        }
        #chat-input:focus { border-color: var(--primary); }

        /* Toast */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: #263238; color: white; padding: 12px 30px;
            border-radius: 30px; z-index: 1000; opacity: 0; transition: opacity 0.5s; pointer-events: none; font-weight: 500;
        }
        #toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div id="toast">ì•Œë¦¼</div>

    <div id="main-view">
        <div id="top-process-panel">
            <div class="process-card" onclick="selectZone('Z_IN')" id="card-Z_IN">
                <div class="p-icon"><i class="fas fa-dolly"></i></div>
                <div class="p-title">ì…ê³ (Inbound)</div>
                <div class="p-count" id="count-Z_IN">0</div>
                <div class="p-desc">Waiting</div>
            </div>
            
            <div class="arrow"><i class="fas fa-arrow-right"></i></div>
            
            <div class="process-card" onclick="selectZone('Z_SORT')" id="card-Z_SORT">
                <div class="p-icon"><i class="fas fa-boxes"></i></div>
                <div class="p-title">ë¶„ë¥˜(Sorting)</div>
                <div class="p-count" id="count-Z_SORT">0</div>
                <div class="p-desc">Processing</div>
            </div>

            <div class="arrow"><i class="fas fa-arrow-right"></i></div>

            <div class="process-card" onclick="selectZone('Z_OUT')" id="card-Z_OUT">
                <div class="p-icon"><i class="fas fa-truck-loading"></i></div>
                <div class="p-title">ì¶œê³ (Outbound)</div>
                <div class="p-count" id="count-Z_OUT">0</div>
                <div class="p-desc">Shipping</div>
            </div>
        </div>

        <div id="bottom-graph-panel">
            <div class="panel-label"><i class="fas fa-project-diagram" style="color:var(--primary)"></i> Korea Logistics Ontology</div>
            <div id="graph-container"></div>
        </div>
    </div>

    <div id="sidebar">
        <div id="info-panel">
            <div class="info-header"><i class="fas fa-chart-line"></i> ìš´ì˜ í˜„í™© (Status)</div>
            <div id="info-content" style="color:#78909C; line-height: 1.6;">
                êµ¬ì—­ì„ í´ë¦­í•˜ì—¬<br>ìƒì„¸ ì˜¨í†¨ë¡œì§€ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </div>
            
            <div style="margin-top:30px; font-weight:bold; margin-bottom:15px; color:#37474F;">ğŸ”” ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ë¡œê·¸</div>
            <div id="event-list"></div>
        </div>

        <div id="chat-panel">
            <div id="messages">
                <div class="msg bot">ë°˜ê°‘ìŠµë‹ˆë‹¤. <b>í•œêµ­ë¬¼ë¥˜ AI ê´€ì œ ì‹œìŠ¤í…œ</b>ì…ë‹ˆë‹¤. ğŸ‡°ğŸ‡·<br>ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</div>
            </div>
            <div id="input-area">
                <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ ì…ë ¥ (ì˜ˆ: 'í˜„ì¬ ë³‘ëª© êµ¬ê°„ì€?')..." onkeypress="if(event.key==='Enter') send()">
            </div>
        </div>
    </div>

    <script>
        // 1. Vis.js ê·¸ë˜í”„ ì„¤ì •
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const container = document.getElementById('graph-container');
        const network = new vis.Network(container, { nodes, edges }, {
            nodes: { 
                shape: 'dot', size: 25, 
                font: { face: 'sans-serif', color: '#455A64', size: 14 },
                borderWidth: 2, shadow: true
            },
            edges: { color: '#B0BEC5', arrows: 'to', width: 2, smooth: {type: 'continuous'} },
            physics: {
                enabled: true,
                solver: 'forceAtlas2Based',
                stabilization: { enabled: true, iterations: 200 }
            },
            interaction: { hover: true, zoomView: true }
        });

        // [ì¤‘ìš”] ì´ˆê¸°í™” í›„ ë¬¼ë¦¬ì—”ì§„ ë„ê¸° + í™”ë©´ ë§ì¶¤
        network.once("stabilizationIterationsDone", () => {
            network.setOptions({ physics: { enabled: false } });
            network.fit(); // ê·¸ë˜í”„ë¥¼ í™”ë©´ ì¤‘ì•™ì— ê½‰ ì°¨ê²Œ ë§ì¶¤
        });

        // 2. ë°ì´í„° ì—…ë°ì´íŠ¸
        let globalStats = null;
        let isFirstLoad = true;

        async function updateData() {
            try {
                // ìƒë‹¨ í†µê³„
                const dRes = await fetch('/api/dashboard-stats');
                globalStats = await dRes.json();
                
                globalStats.zones.forEach(z => {
                    const el = document.getElementById(`count-${z.id}`);
                    if (el) el.innerText = z.count;
                });

                const evtDiv = document.getElementById('event-list');
                evtDiv.innerHTML = '';
                globalStats.events.forEach(e => {
                    const isErr = e.type === 'ERROR';
                    evtDiv.innerHTML += `
                        <div class="event-item ${isErr ? 'error' : ''}">
                            <div style="font-weight:bold; margin-bottom:4px; color:${isErr ? '#D32F2F' : '#7B1FA2'}">${isErr ? 'âš  ì¥ì•  ê°ì§€' : 'âœ¨ í”„ë¡œëª¨ì…˜'}</div>
                            ${e.desc}
                        </div>`;
                });

                // í•˜ë‹¨ ê·¸ë˜í”„
                const gRes = await fetch('/api/graph-data');
                const gData = await gRes.json();
                
                // ê¸°ì¡´ ë…¸ë“œ ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸
                if (gData.nodes.length > 0) {
                    nodes.update(gData.nodes);
                    edges.update(gData.edges);
                    
                    // ë°ì´í„°ê°€ ì²˜ìŒ ë¡œë“œë˜ì—ˆì„ ë•Œ í•œ ë²ˆ ë” fit ì‹¤í–‰ (í™•ì‹¤í•˜ê²Œ ë³´ì´ê¸° ìœ„í•´)
                    if (isFirstLoad) {
                        network.fit();
                        isFirstLoad = false;
                    }
                }

            } catch (e) { console.error(e); }
        }
        setInterval(updateData, 2000);

        // 3. UI ì¸í„°ë™ì…˜
        window.selectZone = function(zoneId) {
            document.querySelectorAll('.process-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${zoneId}`).classList.add('active');

            const zData = globalStats.zones.find(z => z.id === zoneId);
            if (zData) {
                document.getElementById('info-content').innerHTML = `
                    <div style="font-size:1.4rem; font-weight:bold; color:var(--primary); margin-bottom:10px;">${zData.name}</div>
                    <div style="font-size:1.1rem; color:#37474F;">ğŸ“¦ í˜„ì¬ ë¬¼ë™ëŸ‰: <b>${zData.count}</b> Units</div>
                    <div style="margin-top:20px; padding:10px; background:#ECEFF1; border-radius:8px;">
                        <div style="font-size:0.9rem; color:#78909C;">ZONE ID</div>
                        <div style="font-family:monospace; font-weight:bold;">${zData.id}</div>
                    </div>
                `;
            }

            // í•´ë‹¹ ë…¸ë“œë¡œ ì¤Œì¸
            network.selectNodes([zoneId]);
            network.focus(zoneId, { animation: true, scale: 1.2 });
        }

        // 4. ì±„íŒ…
        async function send() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if (!text) return;

            addMsg(text, 'user');
            input.value = '';

            const res = await fetch('/api/chat', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text})
            });
            const data = await res.json();
            addMsg(data.reply, 'bot');
            
            if (data.related_nodes && data.related_nodes.length > 0) {
                network.selectNodes(data.related_nodes);
                network.fit({ nodes: data.related_nodes, animation: true });
                showToast("ê´€ë ¨ ë…¸ë“œê°€ ê°•ì¡°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        function addMsg(txt, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = txt; // HTML íƒœê·¸ í—ˆìš©
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 99999;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
